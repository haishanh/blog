<!DOCTYPE html><html><head><title>更美观的serve静态文件 | Carlog</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><link rel="alternate" href="atom.xml" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/main.css" type="text/css"></head><body><header><div class="wrapper"><a href="/" class="site-title"><code>Carlog</code></a><div class="menu"><span class="hamburger"><span></span></span></div><nav role="navigation" class="nav"><a href="/">Home</a><a href="/archives">Archives</a><a href="/atom.xml">RSS</a></nav></div></header><section class="main post"><div class="wrapper clearfix"><div class="post-header"><h2 class="post-title"><a href="/2016/serve-index/">更美观的serve静态文件</a></h2><time datetime="2016-06-13T16:00:00.000Z">June 14, 2016</time></div><div class="post-content"><h2 id="With-nginx"><a href="#With-nginx" class="headerlink" title="With nginx"></a>With nginx</h2><p>用 ningx 来 serving 静态文件，一般是这样配置的:</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><div class="line"><span class="attribute">location</span> /static &#123;</div><div class="line">    <span class="attribute">root</span> /opt/static;</div><div class="line">    <span class="attribute">autoindex</span> <span class="literal">on</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>It works, but it’s not pretty and unable to customize.</p>
<h2 id="Using-express-and-serve-index"><a href="#Using-express-and-serve-index" class="headerlink" title="Using express and serve-index"></a>Using express and serve-index</h2><p>为了更美观，可以使用 <em>nginx</em> + <em>express</em> + <em>serve-index</em>。 nginx 在这里用来 serving 静态文件本身，而 express + serve-index 只用来 serving 目录的 index 页面。需要说明的是，在这里 express 并不是必须的，也可以使用 Node 自带的 http server，这里使用 express 只是为了方便。</p>
<p>当然你首先要安装好 express 和 serve-index, 然后这样使用：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="meta">#!/home/haishanh/.nvm/versions/node/v5.6.0/bin/node</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">const</span> serveIndex = <span class="built_in">require</span>(<span class="string">'serve-index'</span>);</div><div class="line"><span class="keyword">const</span> app = express();</div><div class="line"></div><div class="line"><span class="keyword">const</span> serveOpt = &#123;</div><div class="line">  icons: <span class="literal">true</span>,</div><div class="line">  view: <span class="string">'details'</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line">app.use(<span class="string">'/static'</span>, serveIndex(<span class="string">'/opt/static'</span>, serveOpt));</div><div class="line">app.listen(<span class="number">8001</span>);</div></pre></td></tr></table></figure>
<p>这段内容表示 express + serve-index 会 hosting 目录 <code>/opt/static</code>，使用的url路径为<code>/static</code>。假设以上内容保存为文件<code>serve.js</code>。给这个文件可执行权限，<code>chmod +x serve.js</code>，要注意脚本最开头的 <em>shebang</em> 要指定好，尤其是当你和我一样是用 nvm 来管理 node 版本的时候。</p>
<p>停止 nginx，只运行以上脚本，访问 <code>http://localhost:8001/static/</code> 就可以看到目录 <code>/opt/static</code> 中的内容了，界面也很美观。需要注意的是，此时文件本身并没有被 serve，仍然需要使用 nginx 来 serve 文件。</p>
<p><img src="http://7fva40.com1.z0.glb.clouddn.com/serve-index.png" alt=""></p>
<p>修改 nginx 的配置:</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><div class="line"><span class="keyword">location</span> <span class="title">= /static</span>/ &#123;</div><div class="line">    proxy_pass http://localhost:<span class="number">8001</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">location</span> <span class="title">/static</span> &#123;</div><div class="line">    root /opt/static;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行 <code>server.js</code>，并 start/reload nginx。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">/path/to/serve.js</div><div class="line">nginx <span class="_">-s</span> reload</div></pre></td></tr></table></figure>
<p>试试访问 <code>http://localhost/static/</code>，其中的文件也应该正常被 serve 了。如果你希望 <code>/opt/static</code> 下的所有目录都有 index 页面的话，前面 nginx 配置中的第一个 location 可以改成这样的：</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><div class="line"><span class="attribute">location</span> <span class="regexp">~ ^/static.*/$</span> &#123;</div><div class="line">    <span class="attribute">proxy_pass</span> http://localhost:8001;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Supervise-Monitor"><a href="#Supervise-Monitor" class="headerlink" title="Supervise / Monitor"></a>Supervise / Monitor</h2><p>为了防止 server.js 在运行的过程中意外退出，可以用 <em>pm2</em> 管理一下。当然我们首先要全局安装一下 pm2:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">npm install pm2 -g</div></pre></td></tr></table></figure>
<p>然后就可以用 pm2 来启动 serve.js 了:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">pm2 start /path/to/serve.js --name <span class="string">"serve-index"</span></div></pre></td></tr></table></figure>
<p>可以用 <code>pm2 list</code> 来查看当前 pm2 管理的进程情况。更多命令和用法可以看看<a href="http://pm2.keymetrics.io/docs/usage/quick-start/#cheatsheet" target="_blank" rel="external">PM2 cheatsheet</a></p>
<p>如果需要开机启动，可以运行以下命令，<code>pm2</code>会自动判断操作系统/平台信息，<a href="http://pm2.keymetrics.io/docs/usage/startup/#startup-systems-support" target="_blank" rel="external">相应的进行startup配置</a>。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">sudo pm2 startup</div></pre></td></tr></table></figure>
<p>如果不能识别平台信息，可以尝试手动指定一下，比如我是用的 <code>systemd</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">sudo pm2 startup systemd</div></pre></td></tr></table></figure>
<p><code>pm2</code>会自动生成<code>systemd</code> service 配置文件，并enable这个service，一般这个文件的路径是 <code>/etc/systemd/system/pm2.service</code>。这个服务在 stop 的时候会 dump 当前 pm2 monitor的程序信息，start的时候再 load 这些信息。</p>
</div><div class="post-footer">Updated on 16/07/10</div></div><div class="post-nav"><div style="height: 0; width: 0; position: absolute; visibility: hidden">
  <!-- inject:svg --><svg xmlns="http://www.w3.org/2000/svg"><symbol id="ic_chevron_left_white_24px" viewBox="0 0 24 24">
    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</symbol><symbol id="ic_chevron_right_white_24px" viewBox="0 0 24 24">
    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</symbol></svg><!-- endinjected -->
</div><a href="/2015/gcc-code-coverage/" class="nav next">NEXT<svg class="icon right"><use xlink:href="#ic_chevron_right_white_24px"></use></svg></a></div></section><footer><h3>Carlog</h3><div class="additional"><span>&copy;</span> 2016 <a href="http://hanhaishan.com">Haishan</a><br> Powered by <a href="https://hexo.io">Hexo</a>, theme using <a href="https://github.com/haishanh/hexo-theme-zxcvb">zxcvb</a>, hosted by <a href="https://github.com/haishanh/blog/tree/gh-pages">Github Pages</a></div></footer><script src="/js/script.js"></script></body></html>