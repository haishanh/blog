<!DOCTYPE html><html><head><title>在公司内网使用Github | Carlog</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><link rel="alternate" href="atom.xml" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/main.css" type="text/css"></head><body><header><div class="wrapper"><a href="/" class="site-title"><code>Carlog</code></a><div class="menu"><span class="hamburger"><span></span></span></div><nav role="navigation" class="nav"><a href="/">Home</a><a href="/archives">Archives</a><a href="/atom.xml">RSS</a></nav></div></header><section class="main post"><div class="wrapper clearfix"><div class="post-header"><h2 class="post-title"><a href="/2015/use-github-in-your-company-intranet/">在公司内网使用Github</a></h2><time datetime="2015-06-25T14:12:12.000Z">June 25, 2015</time></div><div class="post-content"><p>在公司内网使用Github前提是你要有能访问Github的HTTP/HTTPS代理。假设HTTP代理是<code>http://1.2.3.4:8000</code>，HTTPS代理是<code>https://1.2.3.4:8000</code>。那么可以在你的<code>.bashrc</code>或者<code>.zshrc</code>中添加下面两行。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="built_in">export</span> HTTP_PROXY=http://1.2.3.4:8000</div><div class="line"><span class="built_in">export</span> HTTPS_PROXY=https://1.2.3.4:8000</div></pre></td></tr></table></figure>
<p>通常这个时候你已经可以<code>clone</code> Github上的repo了（当然要选择https的repo）。但可能还是不能<code>push</code>。   </p>
<a id="more"></a>
<p>如果你需要 <code>push</code>的话，需要借助另外一个工具<a href="http://agroman.net/corkscrew/" target="_blank" rel="external"><code>Corkscrew</code></a>。   </p>
<blockquote>
<p>Corkscrew is a tool for tunneling SSH through HTTP proxies.</p>
</blockquote>
<p>下载Corkscrew的源码，编译安装。通常在公司你应该没有root权限的吧，所以在编译前的configure的时候prefix选择自己可以读写的目录。我在我们公司使用的Scientific Linux上configure的时候，configure不能guess到正确的host type，需要用–host来指定一下。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="built_in">cd</span> &lt;corkscrew_src&gt;</div><div class="line">./confgure --prefix=/home/haishanh --host=i686-pc-linux-gnu</div><div class="line">make </div><div class="line">make install</div></pre></td></tr></table></figure>
<p>然后在<code>~/.ssh/config</code>中填入以下行<br><figure class="highlight lsl"><table><tr><td class="code"><pre><div class="line">ProxyCommand /home/haishanh/bin/corkscrew <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span> <span class="number">8000</span> %h %p</div></pre></td></tr></table></figure></p>
<p>这个时候你<code>clone</code> <code>push</code> <code>pull</code>应该都没问题，因为Corkscrew是tunnel SSH流量的，所以我们要用repo的SSH URL来做这些操作。   </p>
<p>因为上面这个配置存在，你SSH到别的HOST都会从proxy走一遍，所以速度会特别慢，我的做法用个脚本去wrapper一下git，如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line"><span class="function"><span class="title">gen_ssh_config</span></span>()</div><div class="line">&#123;</div><div class="line">  cat&lt;&lt;EOF</div><div class="line">ProxyCommand /home/haishanh/bin/corkscrew 1.2.3.4 8000 %h %p</div><div class="line">EOF</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">cleanup</span></span>()</div><div class="line">&#123;</div><div class="line">  <span class="keyword">if</span> [ <span class="_">-f</span> ~/.ssh/config ]; <span class="keyword">then</span></div><div class="line">    <span class="comment"># echo "cleanup"</span></div><div class="line">    rm -rf ~/.ssh/config</div><div class="line">  <span class="keyword">fi</span>  </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">trap</span> <span class="string">"cleanup"</span> INT EXIT</div><div class="line"></div><div class="line"><span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$1</span>"</span> <span class="_">-a</span> <span class="string">"<span class="variable">$1</span>"</span> == <span class="string">"push"</span> -o <span class="string">"<span class="variable">$1</span>"</span> == <span class="string">"clone"</span> -o <span class="string">"<span class="variable">$1</span>"</span> == <span class="string">"pull"</span> ]; <span class="keyword">then</span></div><div class="line">  <span class="built_in">echo</span> <span class="string">"using corkscrew..."</span></div><div class="line">  gen_ssh_config &gt; ~/.ssh/config</div><div class="line">  <span class="comment"># rw for user only</span></div><div class="line">  chmod 600 ~/.ssh/config</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line">git <span class="string">"<span class="variable">$&#123;@&#125;</span>"</span></div></pre></td></tr></table></figure>
<p>假设这个脚本叫<code>~/bin/mygit.sh</code>，你可以在你的rc文件里面添加一个alias。</p>
<figure class="highlight monkey"><table><tr><td class="code"><pre><div class="line"><span class="keyword">alias</span> <span class="title">git</span>=<span class="string">"~/bin/mygit.sh"</span></div></pre></td></tr></table></figure>
<p>Now you can use github freely.</p>
</div><div class="post-footer">Updated on 16/07/10</div></div><div class="post-nav"><div style="height: 0; width: 0; position: absolute; visibility: hidden">
  <!-- inject:svg --><svg xmlns="http://www.w3.org/2000/svg"><symbol id="ic_chevron_left_white_24px" viewBox="0 0 24 24">
    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</symbol><symbol id="ic_chevron_right_white_24px" viewBox="0 0 24 24">
    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</symbol></svg><!-- endinjected -->
</div><a href="/2015/build-and-install-from-source-with-out-root/" class="nav prev"><svg class="icon left"><use xlink:href="#ic_chevron_left_white_24px"></use></svg>PREVIOUS</a><a href="/2014/graduated_finally/" class="nav next">NEXT<svg class="icon right"><use xlink:href="#ic_chevron_right_white_24px"></use></svg></a></div></section><footer><h3>Carlog</h3><div class="additional"><span>&copy;</span> 2016 <a href="http://hanhaishan.com">Haishan</a><br> Powered by <a href="https://hexo.io">Hexo</a>, theme using <a href="https://github.com/haishanh/hexo-theme-zxcvb">zxcvb</a>, hosted by <a href="https://github.com/haishanh/blog/tree/gh-pages">Github Pages</a></div></footer><script src="/js/script.js"></script></body></html>