<!DOCTYPE html><html><head><title>GCC code coverage小例子 | Carlog</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><link rel="alternate" href="atom.xml" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/main.css" type="text/css"></head><body><header><div class="wrapper"><a href="/" class="site-title"><code>Carlog</code></a><div class="menu"><span class="hamburger"><span></span></span></div><nav role="navigation" class="nav"><a href="/">Home</a><a href="/archives">Archives</a><a href="/atom.xml">RSS</a></nav></div></header><section class="main post"><div class="wrapper clearfix"><div class="post-header"><h2 class="post-title"><a href="/2015/gcc-code-coverage/">GCC code coverage小例子</a></h2><time datetime="2015-11-21T13:29:40.000Z">November 21, 2015</time></div><div class="post-content"><p>有同事问我code coverage的问题，但其实这方面我毛都不懂。所以我也去学习了一下。</p>
<p>Code coverage其实就是去检查我们的测试case是不是把我们的代码都覆盖到了。如果要进行code coverage，release版本是binary不行的，必须要用编译出带有coverage instrumentation的binary。要进行code coverage，大概的步骤是：</p>
<ol>
<li>编译出可以用于coverage的binary</li>
<li>跑test case</li>
<li>收集coverage信息</li>
</ol>
<p>我自己写了个小例子，源码可以在<a href="https://github.com/haishanh/gcc-code-coverage-example" target="_blank" rel="external">这里</a>。我们可以按照这个例子，去执行上面的步骤。首先你的机器上需要安装有<a href="https://www.gnu.org/software/make/" target="_blank" rel="external"><code>make</code></a>, <a href="https://gcc.gnu.org/" target="_blank" rel="external"><code>gcc</code></a>以及<a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_blank" rel="external"><code>lcov</code></a>，gcov是gcc中用于测试code coverage的工具，而lcov是对gcov的一个扩展。</p>
<a id="more"></a>
<p>因为在有些项目中，我们除了编译出可执行文件外，还可能需要编译出一些库文件供别人使用。下载例子之后，我们首先进入<strong>cov</strong>目录。其中<code>hello.c</code>包含函数<code>say_hello()</code>，编译成<code>libhello.so</code>。<code>bye.c</code>包含函数<code>say_bye()</code>，编译成<code>libbye.so</code>。<code>main.c</code>中会根据不同的输入参数调用<code>say_hello()</code>或<code>say_bye()</code>。最终编译出可执行文件<code>say</code>。</p>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><p>运行<code>make</code>就可以编译出这些库文件和可执行文件。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">$ ls  </div><div class="line">bye.c  hello.c  main.c  Makefile  say.h</div><div class="line"></div><div class="line">$ make</div><div class="line">......</div><div class="line"></div><div class="line">$ ls</div><div class="line">bye.c  bye.o  hello.c  hello.o  libbye.so  libhello.so  main.c  Makefile  say  say.h</div><div class="line"></div><div class="line">$ ls -lh say lib*.so</div><div class="line">-rwxr-xr-x 1 vagrant vagrant 6.2K Nov 22 01:24 libbye.so</div><div class="line">-rwxr-xr-x 1 vagrant vagrant 6.2K Nov 22 01:24 libhello.so</div><div class="line">-rwxr-xr-x 1 vagrant vagrant 7.3K Nov 22 01:24 say</div></pre></td></tr></table></figure>
<p>如果我们运行<code>make coverage</code>可以编译出可用于coverage测试的库和可执行文件。</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><div class="line">$ make coverage</div><div class="line">......</div><div class="line"></div><div class="line">$ ls</div><div class="line">bye<span class="selector-class">.c</span>     bye<span class="selector-class">.o</span>    hello<span class="selector-class">.gcno</span>  libbye<span class="selector-class">.so</span>    main<span class="selector-class">.c</span>     Makefile  say<span class="selector-class">.h</span></div><div class="line">bye<span class="selector-class">.gcno</span>  hello<span class="selector-class">.c</span>  hello<span class="selector-class">.o</span>     libhello<span class="selector-class">.so</span>  main<span class="selector-class">.gcno</span>  say</div><div class="line"></div><div class="line">$ ls -lh say lib*<span class="selector-class">.so</span></div><div class="line">-rwxr-xr-x <span class="number">1</span> vagrant vagrant <span class="number">22</span>K Nov <span class="number">22</span> <span class="number">01</span>:<span class="number">25</span> libbye<span class="selector-class">.so</span></div><div class="line">-rwxr-xr-x <span class="number">1</span> vagrant vagrant <span class="number">22</span>K Nov <span class="number">22</span> <span class="number">01</span>:<span class="number">25</span> libhello<span class="selector-class">.so</span></div><div class="line">-rwxr-xr-x <span class="number">1</span> vagrant vagrant <span class="number">23</span>K Nov <span class="number">22</span> <span class="number">01</span>:<span class="number">25</span> say</div></pre></td></tr></table></figure>
<p>首先我们可以看到，相比没有使用coverage选项，多出了几个<code>.gcno</code>文件，库和可执行文件的大小也比之前大出许多。</p>
<p>这是因为我们在<code>make coverage</code>时，gcc的编译和链接过程都加入了<code>-coverage</code>选项。对于gcc，在编译阶段使用<code>-coverage</code>选项相当于使用<code>-fprofile-arcs -ftest-coverage</code>，在链接时使用<code>-coverage</code>选项相当于使用了<code>-lgov</code>。</p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>之后我们便可以进行测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=<span class="variable">$&#123;PWD&#125;</span>:<span class="variable">$&#123;LD_LIBRARY_PATH&#125;</span></div><div class="line">./say h</div></pre></td></tr></table></figure>
<p>其中第一步，是为了让<code>say</code>在运行时可以找到<code>libhello.so</code>和<code>libbye.so</code>这两个库。第二步就是我们的测试步骤，其中<code>h</code>参数，可以让我们只调用<code>say_hello()</code>。</p>
<p>此时，我们会发现我们的目录里，又多出了几个<code>.gcda</code>文件。这些文件就是生成的coverage信息文件。</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><div class="line">$ ls</div><div class="line">bye<span class="selector-class">.c</span>     bye<span class="selector-class">.gcno</span>  hello<span class="selector-class">.c</span>     hello<span class="selector-class">.gcno</span>  libbye<span class="selector-class">.so</span>    main<span class="selector-class">.c</span>     main<span class="selector-class">.gcno</span>  say</div><div class="line">bye<span class="selector-class">.gcda</span>  bye<span class="selector-class">.o</span>     hello<span class="selector-class">.gcda</span>  hello<span class="selector-class">.o</span>     libhello<span class="selector-class">.so</span>  main<span class="selector-class">.gcda</span>  Makefile   say.h</div></pre></td></tr></table></figure>
<h3 id="收集coverage信息"><a href="#收集coverage信息" class="headerlink" title="收集coverage信息"></a>收集coverage信息</h3><figure class="highlight stylus"><table><tr><td class="code"><pre><div class="line">$ lcov -c -d ./ -o coverage<span class="selector-class">.info</span></div><div class="line">Capturing coverage data from ./</div><div class="line">Found gcov version: <span class="number">5.2</span>.<span class="number">0</span></div><div class="line">Scanning ./ <span class="keyword">for</span> <span class="selector-class">.gcda</span> files ...</div><div class="line">Found <span class="number">3</span> data files <span class="keyword">in</span> ./</div><div class="line">Processing main<span class="selector-class">.gcda</span></div><div class="line">Processing bye<span class="selector-class">.gcda</span></div><div class="line">Processing hello<span class="selector-class">.gcda</span></div><div class="line">Finished <span class="selector-class">.info-file</span> creation</div><div class="line"></div><div class="line">$ lcov --remove coverage<span class="selector-class">.info</span> <span class="string">"/usr*"</span> -o coverage<span class="selector-class">.info</span></div><div class="line">Reading tracefile coverage<span class="selector-class">.info</span></div><div class="line">Deleted <span class="number">0</span> files</div><div class="line">Writing data to coverage<span class="selector-class">.info</span></div><div class="line">Summary coverage rate:</div><div class="line">  lines......: <span class="number">53.3%</span> (<span class="number">8</span> of <span class="number">15</span> lines)</div><div class="line">  functions..: <span class="number">66.7%</span> (<span class="number">2</span> of <span class="number">3</span> functions)</div><div class="line">  branches...: no data found</div><div class="line"></div><div class="line">$ genhtml coverage<span class="selector-class">.info</span> -o coverage</div><div class="line">Reading data file coverage<span class="selector-class">.info</span></div><div class="line">Found <span class="number">3</span> entries.</div><div class="line">Found common filename prefix <span class="string">"/home/vagrant/coverage-exapmle/coverage"</span></div><div class="line">Writing <span class="selector-class">.css</span> and <span class="selector-class">.png</span> files.</div><div class="line">Generating output.</div><div class="line">Processing file cov/bye<span class="selector-class">.c</span></div><div class="line">Processing file cov/main<span class="selector-class">.c</span></div><div class="line">Processing file cov/hello<span class="selector-class">.c</span></div><div class="line">Writing directory view page.</div><div class="line">Overall coverage rate:</div><div class="line">  lines......: <span class="number">53.3%</span> (<span class="number">8</span> of <span class="number">15</span> lines)</div><div class="line">  functions..: <span class="number">66.7%</span> (<span class="number">2</span> of <span class="number">3</span> functions)</div></pre></td></tr></table></figure>
<p>第一步，使用<code>lcov</code>生成<code>coverage.ino</code>文件。第二步，我们是去除掉系统的源码调用记录，比如<code>stdio.h</code>什么的。第三步是在coverage目录中生成html格式的报告。此时我们进入coverage，运行<code>python -m SimpleHTTPServer</code>就可以通过浏览器访问本机的8000端口来查看coverage报告了。</p>
<p>从上面的输出，我们可以看到，我们的测试覆盖到了源代码中53.3%行，和66.7%的函数。假设我们把测试步骤中的<code>./say h</code>改成<code>./say</code>，会发现函数的覆盖率变成了100%。</p>
<h3 id="自动化"><a href="#自动化" class="headerlink" title="自动化"></a>自动化</h3><p>在生产环境中，我们通常可以把上面的两个步骤自动化。我们可以把测试的运行写成脚本，然后在Makefile中调用该脚本，再收集coverage信息。进入<strong>auto</strong>目录，运行<code>make coverage</code>你就能明白了。</p>
<p>Ref: <a href="http://ernstsson.net/post/23930158749/code-coverage-for-c-using-gcc-and-lcov" target="_blank" rel="external">Code coverage for C using gcc and lcov</a></p>
</div><div class="post-footer">Updated on 16/07/10</div></div><div class="post-nav"><div style="height: 0; width: 0; position: absolute; visibility: hidden">
  <!-- inject:svg --><svg xmlns="http://www.w3.org/2000/svg"><symbol id="ic_chevron_left_white_24px" viewBox="0 0 24 24">
    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</symbol><symbol id="ic_chevron_right_white_24px" viewBox="0 0 24 24">
    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</symbol></svg><!-- endinjected -->
</div><a href="/2016/serve-index/" class="nav prev"><svg class="icon left"><use xlink:href="#ic_chevron_left_white_24px"></use></svg>PREVIOUS</a><a href="/2015/yum-repo-howto/" class="nav next">NEXT<svg class="icon right"><use xlink:href="#ic_chevron_right_white_24px"></use></svg></a></div></section><footer><h3>Carlog</h3><div class="additional"><span>&copy;</span> 2016 <a href="http://hanhaishan.com">Haishan</a><br> Powered by <a href="https://hexo.io">Hexo</a>, theme using <a href="https://github.com/haishanh/hexo-theme-zxcvb">zxcvb</a>, hosted by <a href="https://github.com/haishanh/blog/tree/gh-pages">Github Pages</a></div></footer><script src="/js/script.js"></script></body></html>