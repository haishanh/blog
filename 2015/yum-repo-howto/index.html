<!DOCTYPE html><html><head><title>自己搞一个Yum源 | Carlog</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><link rel="alternate" href="atom.xml" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/main.css" type="text/css"></head><body><header><div class="wrapper"><a href="/" class="site-title"><code>Carlog</code></a><div class="menu"><span class="hamburger"><span></span></span></div><nav role="navigation" class="nav"><a href="/">Home</a><a href="/archives">Archives</a><a href="/atom.xml">RSS</a></nav></div></header><section class="main post"><div class="wrapper clearfix"><div class="post-header"><h2 class="post-title"><a href="/2015/yum-repo-howto/">自己搞一个Yum源</a></h2><time datetime="2015-11-06T15:21:47.000Z">November 6, 2015</time></div><div class="post-content"><p><a href="/2015/build-and-install-from-source-with-out-root/">无root权限从源码编译安装很痛苦</a>，就算有root权限安装个软件什么的也很麻烦。而且公司的机器又不能访问外网。所以我不如自己搭建一个源镜像，这样大家都可以用。正好实验室有配置比较低的闲置机器，配置一下代理就可以了。由于我们Team基本用的都是Redhat Enterprise Linux或者Cent OS，而且基本上都是7.0+，所以搭建的是EL7的yum源，应该也可以用于其他Enterprise Linux系列distro。</p>
<a id="more"></a>
<p>首先检查机器上是否有<code>reposync</code>和<code>createrepo</code>。前者用于从远端repo中拉取rpm包到本地，后者用于创建repo生产metadata等。没有的话，可以通过yum安装。</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><div class="line">yum <span class="keyword">install</span> yum-utils createrepo</div></pre></td></tr></table></figure>
<p>然后可以写一个，如下的脚本：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line">repos=<span class="string">"base extras updates"</span></div><div class="line"><span class="keyword">for</span> repo <span class="keyword">in</span> <span class="variable">$repos</span>; <span class="keyword">do</span></div><div class="line">  reposync <span class="_">-a</span> x86_64 -r <span class="variable">$repo</span> -p /opt/mirror/el/7/</div><div class="line">  createrepo <span class="string">"/opt/mirror/el/7/<span class="variable">$repo</span>/"</span></div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>
<p>其中<code>repos</code>中是你希望拉取到本地的repo的id。在<code>/etc/yum.repos.d/</code>下面的repo文件一般都是如下的形式：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><div class="line"><span class="section">[one]</span></div><div class="line"><span class="attr">name</span>=Repo <span class="literal">On</span>e</div><div class="line"><span class="attr">baseurl</span>=http://example.com/el7/<span class="literal">on</span>e/</div><div class="line"><span class="attr">enabled</span>=<span class="number">1</span></div><div class="line"><span class="attr">gpgcheck</span>=<span class="number">1</span></div><div class="line"><span class="attr">gpgkey</span>=file:///etc/<span class="literal">on</span>e/</div><div class="line"><span class="section"></span></div><div class="line">[two]</div><div class="line"><span class="attr">name</span>=Repo Two</div><div class="line"><span class="attr">baseurl</span>=http://example.com/el7/two/</div><div class="line"><span class="attr">enabled</span>=<span class="number">1</span></div><div class="line"><span class="attr">gpgcheck</span>=<span class="number">0</span></div></pre></td></tr></table></figure>
<p>其中<code>one</code>和<code>two</code>就是repo id。虽然说是id，但其实可以有多个文件存在相同的repo id。</p>
<p>前面的脚本跑一次一般需要比较长的时间，当然这个要看网络情况。接下来，我们跑一个web server，这里选择nginx。使用yum默认安装的话，nginx使用的默认配置文件应该是<code>/etc/nginx/nginx.conf</code>，添加以下行：</p>
<figure class="highlight lasso"><table><tr><td class="code"><pre><div class="line"><span class="attr">...</span></div><div class="line">http &#123;</div><div class="line">    <span class="attr">...</span></div><div class="line">    server &#123;</div><div class="line">        <span class="attr">...</span></div><div class="line">        location /el/<span class="number">7</span>/ &#123;</div><div class="line">        root   /opt/mirror;</div><div class="line">        autoindex  <span class="keyword">on</span>; </div><div class="line">        &#125;</div><div class="line">        <span class="attr">...</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行nginx</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><div class="line">systemctl <span class="literal">start</span> nginx</div></pre></td></tr></table></figure>
<p>假设主机的IP是1.2.3.4，此时我们访问<code>http://1.2.3.4/el/7/</code>就应该能看到东西了。</p>
<p>我们提供给别人的repo文件，应该是这样：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><div class="line"><span class="section">[base]</span></div><div class="line"><span class="attr">name</span>=Test Repo base</div><div class="line"><span class="attr">baseurl</span>=http://<span class="number">1.2</span>.<span class="number">3.4</span>/el/<span class="number">7</span>/base/</div><div class="line"><span class="attr">enabled</span>=<span class="number">1</span></div><div class="line"><span class="attr">gpgcheck</span>=<span class="number">0</span></div><div class="line"><span class="section"></span></div><div class="line">[extras]</div><div class="line"><span class="attr">name</span>=Test Repo extras</div><div class="line"><span class="attr">baseurl</span>=http://<span class="number">1.2</span>.<span class="number">3.4</span>/el/<span class="number">7</span>/extras/</div><div class="line"><span class="attr">enabled</span>=<span class="number">1</span></div><div class="line"><span class="attr">gpgcheck</span>=<span class="number">0</span></div><div class="line"><span class="section"></span></div><div class="line">[updates]</div><div class="line"><span class="attr">name</span>=Test Repo updates</div><div class="line"><span class="attr">baseurl</span>=http://<span class="number">1.2</span>.<span class="number">3.4</span>/el/<span class="number">7</span>/updates/</div><div class="line"><span class="attr">enabled</span>=<span class="number">1</span></div><div class="line"><span class="attr">gpgcheck</span>=<span class="number">0</span></div></pre></td></tr></table></figure>
<p>我只是公司内网使用，就不管什么gpgkey了。gpgcheck全设为0。</p>
<p>如果我们还有点<em>情怀</em>，我们还应该提供一个mirror使用的帮助页面，比如<a href="http://mirrors.163.com/.help/centos.html" target="_blank" rel="external">网易CentOS镜像使用帮助</a>。用markdown写个，转成html，存到<code>/opt/mirror/el/7/help/index.html</code>就可以了。</p>
</div><div class="post-footer">Updated on 16/07/10</div></div><div class="post-nav"><div style="height: 0; width: 0; position: absolute; visibility: hidden">
  <!-- inject:svg --><svg xmlns="http://www.w3.org/2000/svg"><symbol id="ic_chevron_left_white_24px" viewBox="0 0 24 24">
    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</symbol><symbol id="ic_chevron_right_white_24px" viewBox="0 0 24 24">
    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</symbol></svg><!-- endinjected -->
</div><a href="/2015/gcc-code-coverage/" class="nav prev"><svg class="icon left"><use xlink:href="#ic_chevron_left_white_24px"></use></svg>PREVIOUS</a><a href="/2015/linux-network-namespace/" class="nav next">NEXT<svg class="icon right"><use xlink:href="#ic_chevron_right_white_24px"></use></svg></a></div></section><footer><h3>Carlog</h3><div class="additional"><span>&copy;</span> 2016 <a href="http://hanhaishan.com">Haishan</a><br> Powered by <a href="https://hexo.io">Hexo</a>, theme using <a href="https://github.com/haishanh/hexo-theme-zxcvb">zxcvb</a>, hosted by <a href="https://github.com/haishanh/blog/tree/gh-pages">Github Pages</a></div></footer><script src="/js/script.js"></script></body></html>