<!DOCTYPE html><html><head><title>Vagrant是个好东西 | Carlog</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><link rel="alternate" href="atom.xml" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/main.css" type="text/css"></head><body><header><div class="wrapper"><a href="/" class="site-title"><code>Carlog</code></a><div class="menu"><span class="hamburger"><span></span></span></div><nav role="navigation" class="nav"><a href="/">Home</a><a href="/archives">Archives</a><a href="/atom.xml">RSS</a></nav></div></header><section class="main post"><div class="wrapper clearfix"><div class="post-header"><h2 class="post-title"><a href="/2015/vagrant-is-pretty-good/">Vagrant是个好东西</a></h2><time datetime="2015-10-24T15:26:39.000Z">October 24, 2015</time></div><div class="post-content"><p>对Macbook Pro蠢蠢欲动很久了，除了因为Mac好看，界面友好外。还有一部分是因为，Mac OS是Unix-like的系统，开发友好。然而我还买不起。所以在Windows一般都是安装Linux虚拟机来当开发环境使用。免费的VirtualBox也很不错。</p>
<p>但要用VirtualBox搭建个开发环境，我们通常需要下载系统iso镜像，然后安装系统。比如安装Ubuntu Desktop，虽然安装过程都是GUI，点点鼠标就行，但毕竟过程需要一点时间，而且中途需要你人工操作。要是安装Arch Linux这样的distro，安装过程没有GUI，安装过程麻烦，且安装过程一直需要一些操作。系统安装完了，我们通常需要一些简单的网络配置，比如让主机可以直接访问虚拟机，或者配置端口转发。有时，我们还可能需要更方便的文件交换，又需要配置共享文件夹。这些使用Virtualbox和VMWare的虚拟机软件都可以实现，这些东西配置一两次还行，如果你需要经常配置一个新的虚拟机的话，就会觉得很麻烦。</p>
<a id="more"></a>
<p>还好有<a href="https://www.vagrantup.com/" target="_blank" rel="external">Vagrant</a>这么个东西，以上这些操作都变的很简单。Vagrant并不是像VirtualBox这样的提供虚拟化功能的平台性软件。它就像是对VirtualBox和VMware这些软件的操作和配置的一个统一包装。对于Vagrant来说，VirtualBox， VMWare这样的软件称为<a href="https://docs.vagrantup.com/v2/providers/" target="_blank" rel="external">provider</a>。要使用Vagrant，除了要安装Vagrant本身以外，还需要provider。Vagrant中有个叫<a href="https://docs.vagrantup.com/v2/getting-started/boxes.html" target="_blank" rel="external">Box</a>的概念，一个box就是一个已经拥有系统的镜像，它会作为虚拟机模板。在创建一个单独的虚拟机实例之前，需要先添加box。比如以下命令会从官方的<a href="https://atlas.hashicorp.com/boxes/search" target="_blank" rel="external">Catalog</a>下载并添加名字叫”hashicorp/precise32”的box：</p>
<figure class="highlight armasm"><table><tr><td class="code"><pre><div class="line"><span class="symbol">vagrant</span> <span class="keyword">box </span><span class="keyword">add </span>hashicorp/precise32</div></pre></td></tr></table></figure>
<p>在这个Catalog中有很多可以选择的box。但在国内，像这样在线添加box速度会很慢。我们可以从别的地方通过其他方式下载我们需要box，再指定目录添加到vagrant中。比我现在用的是terrywang做的<a href="https://github.com/terrywang/vagrantboxes/blob/master/archlinux-x86_64.md" target="_blank" rel="external">Arch Linux x86_64 Base Box</a></p>
<figure class="highlight processing"><table><tr><td class="code"><pre><div class="line">vagrant <span class="built_in">box</span> <span class="built_in">add</span> &lt;<span class="built_in">box</span>-name&gt; &lt;/path/to/<span class="built_in">box</span>&gt;</div></pre></td></tr></table></figure>
<p>其中<box-name>是我们想给这个box起的一个名字，比如<code>arch-box-64</code>，后面在创建虚拟机时会用到。接下来，我们只需要创建一个目录，并在该目录中初始化我们的环境就可以了。</box-name></p>
<figure class="highlight stata"><table><tr><td class="code"><pre><div class="line"><span class="keyword">mkdir</span> arch0</div><div class="line"><span class="keyword">cd</span> arch0</div><div class="line">vagrant init <span class="keyword">arch</span>-box-64</div></pre></td></tr></table></figure>
<p>在init后，在这个目录下就会生成一个<code>Vagrantfile</code>。这个<code>Vagrantfile</code>是Vagrant中的关键。在上面步骤中生成的<code>Vagrantfile</code>，去掉其中很多解释性的注释后，内容大概如下：</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><div class="line">Vagrant.configure(<span class="string">"2"</span>) <span class="built_in">do</span> |<span class="built_in">config</span>|</div><div class="line">  <span class="built_in">config</span>.vm.box = <span class="string">"arch-box-64"</span></div><div class="line"><span class="built_in">end</span></div></pre></td></tr></table></figure>
<p>然后，我们起虚拟机：</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><div class="line"><span class="attribute">vagrant</span> up</div></pre></td></tr></table></figure>
<p>第一次起，时间会比较长一点。以后每次up的时候，都会比较快。然后可以通过以下命令登录到guest<a href="本文中称运行虚拟机软件的机器叫主机或host，称其中运行的虚拟机实例为虚拟机或guest。不做严谨的区分。">^1</a>:</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><div class="line"><span class="attribute">vagrant</span> ssh</div></pre></td></tr></table></figure>
<p>由于每一个<strong>标准</strong>的vagrant box在制作的时候，都已经把vagrant官方提供的一个ssh public key添加到box中ssh的authorized_keys中。所以这个登录的时候，不需要输入密码，登录的用户名是vagrant。实际上，虚拟机是把其22(sshd)端口转发到主机的2222端口。所以我们可以通过Putty或者XShell这样的软件登录到127.0.0.1:2222，如果在这些软件中觉得用ssh key比较麻烦的话，输入密码也可以登录，默认的密码也为vagrant。这个guest中root的默认密码也为vagrant，默认也设置好了passwordless sudo。同时，我们在host上创建的这个<code>arch0</code>这个目录，会自动挂载到guest的<code>/vagrant</code>目录上，文件共享。虚拟机使用完了，如果这个虚拟机以后也不需要了，可以destroy掉。如果以后还需要使用，可以在虚拟机中直接<code>sudo shutdown -h now</code>，也可以在外面运行<code>vagrant halt</code>来关闭虚拟机。以后需要使用的话，再进入这个<code>arch0</code>目录，来up这个虚拟机。</p>
<p>知道了以上这些就已经足够我们愉快的玩耍了。这些password less sudo，key based ssh login，port forward, directory sharing等都可以直接在虚拟机以及VirtualBox中做相应的配置来完成，但有了Vagrant，我们不需自己来做这些配置，而且box已经是拥有系统的模板，我们不需要自己安装。不仅是自己玩耍，甚至在商业上可以把自己的产品集成到Vagrant box中，把这个box作为最终的产品进行交付。</p>
<p>前面提到<a href="https://docs.vagrantup.com/v2/vagrantfile/index.html" target="_blank" rel="external"><code>Vagrantfile</code></a>中，我们可以做更多自定义的配置，比如有了如下配置，我们可以通过访问host的8080端口访问guest的80端口。</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><div class="line">Vagrant.configure(<span class="string">"2"</span>) <span class="built_in">do</span> |<span class="built_in">config</span>|</div><div class="line">  ...</div><div class="line">  <span class="built_in">config</span>.vm.network <span class="string">"forwarded_port"</span>, guest: <span class="number">80</span>, host: <span class="number">8080</span></div><div class="line">  ...</div><div class="line"><span class="built_in">end</span></div></pre></td></tr></table></figure>
<p>Vagrantfile中也可以定义内存大小，主机名，ssh登录信息等。除了这些，Vagrantfile中也可以设置一些shell script，让虚拟机在创建时运行它们，比如一些软件的安装命令。更多的参见vagrant的文档。</p>
<p>另，如果要使用64位的虚拟机，主机的BIOS要打开相应处理器厂商的虚拟化技术。</p>
</div><div class="post-footer">Updated on 16/07/10</div></div><div class="post-nav"><div style="height: 0; width: 0; position: absolute; visibility: hidden">
  <!-- inject:svg --><svg xmlns="http://www.w3.org/2000/svg"><symbol id="ic_chevron_left_white_24px" viewBox="0 0 24 24">
    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</symbol><symbol id="ic_chevron_right_white_24px" viewBox="0 0 24 24">
    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</symbol></svg><!-- endinjected -->
</div><a href="/2015/linux-network-namespace/" class="nav prev"><svg class="icon left"><use xlink:href="#ic_chevron_left_white_24px"></use></svg>PREVIOUS</a><a href="/2015/flash-marshmallow-nexus-5/" class="nav next">NEXT<svg class="icon right"><use xlink:href="#ic_chevron_right_white_24px"></use></svg></a></div></section><footer><h3>Carlog</h3><div class="additional"><span>&copy;</span> 2016 <a href="http://hanhaishan.com">Haishan</a><br> Powered by <a href="https://hexo.io">Hexo</a>, theme using <a href="https://github.com/haishanh/hexo-theme-zxcvb">zxcvb</a>, hosted by <a href="https://github.com/haishanh/blog/tree/gh-pages">Github Pages</a></div></footer><script src="/js/script.js"></script></body></html>